/*
 * fis
 * http://fis.baidu.com/
 */

'use strict';

function replaceDefine(value, escape){
    //将里面的这类{$namespace}替换成在config设置的变量
    return value.replace(/\$\{([^\}]+)\}/g, function(all, $1){
        var val = fis.config.get($1);
        if(typeof val === 'undefined'){
            fis.log.error('undefined property [' + $1 + '].');
        } else {
            return escape ? fis.util.escapeReg(val) : val;
        }
        return all;
    });
}

function replaceMatches(value, matches){
    return value.replace(/\$(\d+|&)/g, function(all, $1){
        //&替换成全部匹配结果
        //否则替换成对应位置的结果
        return matches[$1 === '&' ? '0' : $1] || all;
    });
}

function replaceProperties(source, matches, target){
    var type = typeof source;
    if(type === 'object'){
        if(fis.util.is(source, 'Array')){
            target = target || [];
        } else {
            target = target || {};
        }
        //遍历递归所有value值替换成匹配的结果
        //source = {reg: '**', release: '$1', extras : { say : '123' }}
        fis.util.map(source, function(key, value){
            target[key] = replaceProperties(value, matches);
        });
        return target;
    } else if(type === 'string'){
        //先替换全局设置的变量
        //再替换撇陪的结果
        return replaceDefine(replaceMatches(source, matches));
// TODO support function type
//    } else if(type === 'function'){
//        return source(subpath || target.subpath, matches);
    } else {
        return source;
    }
}

function roadmap(subpath, path, obj){
    //获取配置配置的`roadmap.path`
    var map = fis.config.get('roadmap.' + path, []);
    for(var i = 0, len = map.length; i < len; i++){
        var opt = map[i], reg = opt.reg;
        if(reg){
            //reg可以是字符串
            if(typeof reg === 'string'){
                //replaceDefine，例如替换reg里面用到的{$namespace}
                reg = fis.util.glob(replaceDefine(reg, true));
            } else if(!fis.util.is(reg, 'RegExp')){
                fis.log.error('invalid regexp [' + reg + '] of [roadmap.' + path + '.' + i + ']');
            }
            var matches = subpath.match(reg);
            if(matches){
                obj = obj || {};
                //将opt里面用到的变量替换成匹配（mactches）已经赋值的变量($namespace)和匹配的结果($0、$&)
                //然后拷贝到obj上
                replaceProperties(opt, matches, obj);
                delete obj.reg;
                return obj;
            }
        } else {
            //如果没有填写reg属性会报错
            fis.log.error('[roadmap.' + path + '.' + i + '] missing property [reg].');
        }
    }
    return false;
}

var uri = module.exports = function(path, dirname){
    var info = fis.util.stringQuote(path),
        qInfo = fis.util.query(info.rest);
    //例如在1.jped中qInfo.query是?___inline,
    info.query = qInfo.query;
    info.hash = qInfo.hash;
    info.rest = qInfo.rest;
    if(info.rest){
        path = info.rest;
        if(path.indexOf(':') === -1){
            var file;
            if(path[0] === '/'){
                file = fis.project.getProjectPath(path);
            } else if(dirname) {
                file = fis.util(dirname, path);
            } else {
                fis.log.error('invalid dirname.');
            }
            //根据路径转换成File对象
            if(file && fis.util.isFile(file)){
                info.file = fis.file(file);
            }
        }
    }
    return info;
};
//根据你path和文件夹获取id
uri.getId = function(path, dirname){
    var info = uri(path, dirname);
    if(info.file){
        info.id = info.file.getId();
    } else {
        info.id = info.rest;
    }
    return info;
};

uri.replaceDefine = replaceDefine;
uri.replaceMatches = replaceMatches;
uri.replaceProperties = replaceProperties;
uri.roadmap = roadmap;